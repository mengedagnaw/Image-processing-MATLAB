%% fracture_detection_filters.m
% Fracture detection using filtering + edge detection + white pixel counts
% Image path: /MATLAB Drive/crack3.png

clear; close all; clc;

%% 1) Image Loading
imgPath = "/MATLAB Drive/crack3.png";
if ~isfile(imgPath)
    error("Image not found: %s\nCheck the path and filename.", imgPath);
end

I = imread(imgPath);
figure('Name','Original'); imshow(I); title('Original RGB Image');

%% Convert to grayscale
I_gray = im2gray(I);
figure('Name','Grayscale'); imshow(I_gray); title('Grayscale Image');

%% 2) Low-Pass Filtering (Gaussian Blur)
sigmaLP = 12;  % adjustable
lowPassI = imgaussfilt(I_gray, sigmaLP);
figure('Name','Low-pass Gaussian'); imshow(lowPassI);
title(sprintf('Low Pass (Gaussian Blur), \\sigma = %.2f', sigmaLP));

%% 3) High-Pass Filtering: Sobel Edge Detection
highPass_on_LP = edge(lowPassI, 'sobel');
figure('Name','Sobel on Low-pass'); imshow(highPass_on_LP);
title('High Pass: Sobel on Low-Pass Image');

highPass_only = edge(I_gray, 'sobel');
figure('Name','Sobel only'); imshow(highPass_only);
title('High Pass: Sobel only (on grayscale)');

%% 4) Combined Filtering: Laplacian of Gaussian (LoG)
% edge(...,'log',threshold,sigma)
logThresh = 0.2;   % adjustable
logSigma  = 0.95;  % adjustable
logI = edge(I_gray, 'log', logThresh, logSigma);
figure('Name','LoG'); imshow(logI);
title(sprintf('Combined LoG (thr=%.2f, \\sigma=%.2f)', logThresh, logSigma));

%% 5) White Pixel Counts (for each method)
countSobelLP   = nnz(highPass_on_LP);
countSobelOnly = nnz(highPass_only);
countLoG       = nnz(logI);

fprintf("\n=== White Pixel Counts ===\n");
fprintf("Sobel on Low-pass : %d\n", countSobelLP);
fprintf("Sobel only        : %d\n", countSobelOnly);
fprintf("LoG               : %d\n", countLoG);

%% Choose which map to use for decision
% Best default: LoG (often cleaner for crack-like edges)
numWhitePixels = countLoG;

%% Threshold selection
% Option 1 (manual): set your own threshold
thresholdCount = 100;  % adjustable

% Option 2 (auto): uncomment to estimate threshold from image size
% thresholdCount = round(0.001 * numel(I_gray));  % 0.1% of all pixels

fprintf("\nDecision based on LoG white pixels = %d (threshold = %d)\n", ...
    numWhitePixels, thresholdCount);

%% If / elseif / else decision
if numWhitePixels > thresholdCount
    disp('Fracture Detected: White pixel count indicates a crack.');
elseif numWhitePixels > 0 && numWhitePixels <= thresholdCount
    disp('Possible Fracture: Low white pixel count suggests a minor defect.');
else
    disp('No Fracture Detected: No significant cracks found.');
end

%% (Optional) Overlay edges on grayscale for visual confirmation
overlay = imoverlay(I_gray, logI, [1 0 0]); % red overlay
figure('Name','LoG edges overlay'); imshow(overlay);
title('LoG Edges Overlay (Red)');

%% Helper: imoverlay (in case itâ€™s not available in your MATLAB)
function out = imoverlay(imgGray, mask, colorRGB)
% Create a simple overlay image (RGB) from grayscale + binary mask
imgGray = im2double(imgGray);
out = repmat(imgGray, 1, 1, 3);
mask = logical(mask);

out(:,:,1) = out(:,:,1).*(~mask) + colorRGB(1).*mask;
out(:,:,2) = out(:,:,2).*(~mask) + colorRGB(2).*mask;
out(:,:,3) = out(:,:,3).*(~mask) + colorRGB(3).*mask;
end
